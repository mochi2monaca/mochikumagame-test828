<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>もちくまの休日ハント</title>
  <style>
    /* 元の安定レイアウトを完全再現 */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #f0f0f0; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; display: flex; justify-content: center; align-items: center; }
    #game-wrap { width: 100vw; max-width: 450px; height: 100vh; height: 100dvh; position: relative; background: #eef6ff; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    
    #status { height: 60px; display: flex; align-items: center; padding: 0 15px; font-weight: bold; color: #666; background: #f5faff; border-bottom: 1px solid #dee7ef; z-index: 50; }
    #score { font-size: 0.9rem; white-space: nowrap; color: #497297; }
    .spacer { flex-grow: 1; }
    .status-right { display: flex; align-items: center; gap: 12px; }
    #life { display: flex; align-items: center; gap: 4px; color: #ff6b6b; font-size: 0.9rem; white-space: nowrap; }
    .heart-container { display: flex; gap: 2px; align-items: center; }
    .heart-icon { width: 22px; height: 22px; object-fit: contain; display: block; }
    
    #mute-btn { width: 30px; height: 30px; background-color: transparent; background-size: contain; background-repeat: no-repeat; background-position: center; border: none; cursor: pointer; outline: none; -webkit-appearance: none; }
    
    #game-field { flex: 1; position: relative; overflow: hidden; width: 100%; }

    /* もちくま本体：ここが点滅対策のキモ */
    #mochikuma { 
      width: 120px; height: 132px; position: absolute; bottom: 40px; left: 50%; 
      transform: translate3d(-50%, 0, 0); 
      transition: transform 0.1s ease-out; z-index: 5; 
      will-change: transform;
    }
    #mochikuma.dodging { transform: translate3d(50%, 0, 0); }

    /* 重ねるレイヤーのスタイル */
    .mk-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-size: contain; background-repeat: no-repeat; background-position: center bottom;
      opacity: 0; transition: opacity 0.05s; /* 極短のフェードで滑らかに */
      pointer-events: none;
    }
    .mk-layer.show { opacity: 1; }

    .obj { position: absolute; left: 50%; top: 0; width: 80px; height: 80px; background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 4; transform: translate3d(-50%, -100px, 0); will-change: transform; }

    @keyframes poyon {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    #msg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; display: flex; justify-content: center; align-items: flex-start; padding-top: 90px; z-index: 20; pointer-events: none; }
    #msg-content { pointer-events: auto; text-align: center; padding: 35px 20px; background-image: url('./kumo.png'); background-size: 100% 100%; width: 320px; height: 227px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #title-logo { max-width: 280px; height: auto; margin-bottom: 12px; display: block; animation: poyon 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform-origin: center; }
    
    #rule-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    #rule-content { position: relative; width: 90%; max-width: 344px; line-height: 0; }
    #rule-img { width: 100%; height: auto; border-radius: 12px; }
    #close-rule-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 8px 24px; font-size: 0.9rem; font-weight: bold; border-radius: 8px; border: 1px solid #ccc; background: #fff; color: #497297; }

    #msg-text { font-size: 1rem; font-weight: bold; margin-bottom: 10px; color: #497297; line-height: 1.4; display: block; }
    #start-btn, #rule-btn, #share-btn { padding: 6px 16px; margin: 4px; font-size: 0.85rem; font-weight: bold; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; color: #497297; }
    #start-btn { background: #E3F3FF; }
    #rule-btn { background: #fff; }
    #share-btn { background: #fff; border: 1px solid #ccc; display: none; }

    #ui-area { height: 140px; display: flex; align-items: center; justify-content: center; background: #f5faff; border-top: 1px solid #dee7ef; z-index: 10; padding-bottom: env(safe-area-inset-bottom); }
    #dodge-btn { display: none; width: 70%; height: 80px; font-size: 1.8rem; font-weight: bold; background: #0056b3; border: none; border-radius: 40px; color: #ffffff; outline: none; box-shadow: 0 4px 0 #003d7a; }
    
    #loading-text { font-weight: bold; color: #aaa; padding: 30px; }
    #preloader { position: absolute; width: 0; height: 0; overflow: hidden; opacity: 0; }
  </style>
</head>
<body>
<div id="preloader"></div>
<div id="game-wrap">
  <div id="status">
    <div id="score">SCORE: 0</div>
    <div class="spacer"></div>
    <div class="status-right">
      <div id="life">LIFE：<span id="heart-wrap" class="heart-container"></span></div>
      <button id="mute-btn" type="button"></button>
    </div>
  </div>
  <div id="game-field">
    <div id="mochikuma">
      <div id="l-normal" class="mk-layer show" style="background-image: url('./default.png');"></div>
      <div id="l-dodge" class="mk-layer" style="background-image: url('./yoke.png');"></div>
      <div id="l-get" class="mk-layer" style="background-image: url('./default-get.png');"></div>
      <div id="l-go-sigoto" class="mk-layer" style="background-image: url('./gameover-shigoto.png');"></div>
      <div id="l-go-kazi" class="mk-layer" style="background-image: url('./gameover-kazi.png');"></div>
      <div id="l-go-gakkou" class="mk-layer" style="background-image: url('./gameover-gakkou.png');"></div>
      <div id="l-go-yasumi" class="mk-layer" style="background-image: url('./yasumi.png');"></div>
    </div>
    <div id="countdown" style="display: none; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; color: #555; z-index: 15;"></div>
  </div>
  <div id="msg-layer">
    <div id="msg-content">
      <div id="loading-text">Now loading...</div>
      <div id="menu-area" style="display: none;">
        <img src="./title.png" id="title-logo" alt="もちくまの休日ハント">
        <p id="msg-text" style="display: none;"></p>
        <div id="menu-btns">
          <button id="start-btn">開始</button>
          <button id="share-btn">結果をシェア</button>
          <button id="rule-btn">ルール</button>
        </div>
      </div>
    </div>
  </div>
  <div id="rule-layer" style="display: none;">
    <div id="rule-content">
      <img src="./rule.png" id="rule-img" alt="ルール説明">
      <button id="close-rule-btn">閉じる</button>
    </div>
  </div>
  <div id="ui-area">
    <button id="dodge-btn">よける</button>
  </div>
</div>

<script>
// 基本要素
const mk = document.getElementById('mochikuma');
const dodgeBtn = document.getElementById('dodge-btn');
const msgLayer = document.getElementById('msg-layer');
const ruleLayer = document.getElementById('rule-layer');
const countdownDisp = document.getElementById('countdown');
const msgText = document.getElementById('msg-text');
const titleLogo = document.getElementById('title-logo');
const scoreDisp = document.getElementById('score');
const heartWrap = document.getElementById('heart-wrap');
const startBtn = document.getElementById('start-btn');
const ruleBtn = document.getElementById('rule-btn');
const shareBtn = document.getElementById('share-btn');
const closeRuleBtn = document.getElementById('close-rule-btn');
const loadingText = document.getElementById('loading-text');
const menuArea = document.getElementById('menu-area');
const muteBtn = document.getElementById('mute-btn');

// 状態管理
let state = { score: 0, life: 3, active: false, dodging: false, speed: 6, canStart: true, isMuted: false, isSmiling: false, mode: 'title' };
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
let bgmBuffer, getSoundBuffer, bgmSource, bgmGain, spawnTimer;

// レイヤー切り替え（チカつき防止の核心）
function setMKLayer(id) {
  document.querySelectorAll('.mk-layer').forEach(l => l.classList.remove('show'));
  const target = document.getElementById(id);
  if (target) target.classList.add('show');
}

async function loadAudio(url) {
  try {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();
    return await audioCtx.decodeAudioData(buf);
  } catch (e) { return null; }
}

function playBGM() {
  if (!bgmBuffer) return;
  if (bgmSource) bgmSource.stop();
  bgmSource = audioCtx.createBufferSource();
  bgmSource.buffer = bgmBuffer;
  bgmSource.loop = true;
  bgmGain = audioCtx.createGain();
  bgmGain.gain.value = state.isMuted ? 0 : (isMobile ? 0.4 : 0.2);
  bgmSource.connect(bgmGain).connect(audioCtx.destination);
  bgmSource.start(0);
}

function playGetSound() {
  if (!getSoundBuffer || state.isMuted) return;
  const s = audioCtx.createBufferSource();
  const g = audioCtx.createGain();
  s.buffer = getSoundBuffer;
  g.gain.value = 0.3;
  s.connect(g).connect(audioCtx.destination);
  s.start(audioCtx.currentTime);
}

function updateVisual() {
  if (state.mode !== 'game') return;
  if (state.isSmiling) setMKLayer('l-get');
  else if (state.dodging) setMKLayer('l-dodge');
  else setMKLayer('l-normal');
}

const startDodge = (e) => {
  if (e.cancelable) e.preventDefault();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (!state.active) return;
  state.dodging = true; mk.classList.add('dodging'); updateVisual();
};
const endDodge = (e) => {
  state.dodging = false; mk.classList.remove('dodging'); updateVisual();
};

dodgeBtn.addEventListener('touchstart', startDodge, {passive:false});
dodgeBtn.addEventListener('touchend', endDodge, {passive:false});
dodgeBtn.addEventListener('mousedown', startDodge);
window.addEventListener('mouseup', endDodge);

function spawn() {
  if(!state.active) return;
  const obj = document.createElement('div');
  obj.className = 'obj';
  const isNeg = Math.random() > 0.5;
  const types = [{img:'./sigoto.png', l:'l-go-sigoto', n:'仕事'}, {img:'./kazi.png', l:'l-go-kazi', n:'家事'}, {img:'./gakkou.png', l:'l-go-gakkou', n:'学校'}];
  const t = isNeg ? types[Math.floor(Math.random()*3)] : {img:'./kyuzitu.png'};
  obj.style.backgroundImage = `url('${t.img}')`;
  document.getElementById('game-field').appendChild(obj);

  let posY = -100;
  const loop = setInterval(() => {
    if(!state.active) { clearInterval(loop); obj.remove(); return; }
    posY += Math.min(6 + (state.score/50), 18);
    obj.style.transform = `translate3d(-50%, ${posY}px, 0)`;
    
    const oR = obj.getBoundingClientRect(), mR = mk.getBoundingClientRect();
    if (oR.bottom > mR.top + 20 && oR.top < mR.bottom - 20 && oR.right > mR.left + 25 && oR.left < mR.right - 25) {
      if (!state.dodging) {
        if (isNeg) { endGame(t.l, t.n); clearInterval(loop); }
        else {
          state.score += 10; scoreDisp.innerText = `SCORE: ${state.score}`;
          playGetSound(); state.isSmiling = true; updateVisual();
          setTimeout(() => { state.isSmiling = false; updateVisual(); }, 300);
          obj.remove(); clearInterval(loop);
        }
      }
    }
    if (posY > 1000) {
      if (!isNeg) { state.life--; updateLife(); if(state.life<=0) endGame('l-go-yasumi', '休日'); }
      obj.remove(); clearInterval(loop);
    }
  }, 16);
  spawnTimer = setTimeout(spawn, Math.max(1800 - state.score*12, 550));
}

function updateLife() {
  heartWrap.innerHTML = '';
  for(let i=0; i<3; i++) {
    const img = document.createElement('img');
    img.className = 'heart-icon';
    img.src = i < state.life ? './heart-A.png' : './heart-B.png';
    heartWrap.appendChild(img);
  }
}

function endGame(layerId, name) {
  state.active = false; state.mode = 'result'; if(bgmSource) bgmSource.stop();
  clearTimeout(spawnTimer); document.querySelectorAll('.obj').forEach(o => o.remove());
  setMKLayer(layerId);
  titleLogo.style.display = 'none';
  msgText.style.display = 'block';
  msgText.innerHTML = `${name === '休日' ? '休日が足りない…' : name + 'には勝てなかった…'}<br>SCORE: ${state.score}`;
  startBtn.innerText = 'タイトルに戻る';
  ruleBtn.style.display = 'none'; shareBtn.style.display = 'inline-block';
  msgLayer.style.display = 'flex';
}

function backToTitle() {
  state.mode = 'title'; state.score = 0; state.life = 3;
  scoreDisp.innerText = 'SCORE: 0'; updateLife();
  dodgeBtn.style.display = 'none';
  titleLogo.style.display = 'block';
  titleLogo.style.animation = 'none'; titleLogo.offsetHeight; titleLogo.style.animation = null;
  msgText.style.display = 'none';
  startBtn.innerText = '開始';
  ruleBtn.style.display = 'inline-block'; shareBtn.style.display = 'none';
  setMKLayer('l-normal');
}

muteBtn.addEventListener('click', () => {
  state.isMuted = !state.isMuted;
  if (bgmGain) bgmGain.gain.value = state.isMuted ? 0 : (isMobile ? 0.4 : 0.2);
  muteBtn.style.backgroundImage = `url('${state.isMuted ? './volume-OFF.png' : './volume-ON.png'}')`;
});

// 初期化
(async function init() {
  [bgmBuffer, getSoundBuffer] = await Promise.all([loadAudio('./bgm.mp3'), loadAudio('./get.mp3')]);
  loadingText.style.display = 'none'; menuArea.style.display = 'block';
  updateLife();
  muteBtn.style.backgroundImage = "url('./volume-ON.png')";
})();

ruleBtn.addEventListener('click', () => ruleLayer.style.display = 'flex');
closeRuleBtn.addEventListener('click', () => ruleLayer.style.display = 'none');
startBtn.addEventListener('click', () => {
  if (state.mode === 'title') {
    state.mode = 'game'; state.active = true;
    msgLayer.style.display = 'none'; dodgeBtn.style.display = 'block';
    playBGM(); updateLife(); spawn();
  } else { backToTitle(); }
});
shareBtn.addEventListener('click', () => {
  const text = `「もちくまの休日ハント」で遊んだよ！\nスコアは【${state.score}】でした！\n\n#もちくまの休日ハント`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=https://mochikumas-holiday-hunt.vercel.app/`, '_blank');
});
</script>
</body>
</html>
